name: Create and publish a Docker image

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  build:

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: Build and push Docker image
        env:
          GH_REGISTRY_USERNAME: ${{ github.actor }}
          GH_REGISTRY_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ github.repository }}
        run: |
          echo REGISTRY: ${REGISTRY}
          echo GH_REGISTRY_USERNAME: ${GH_REGISTRY_USERNAME}
          echo IMAGE_NAME: ${IMAGE_NAME}
          echo ${GH_REGISTRY_TOKEN} | docker login ${REGISTRY} -u ${GH_REGISTRY_USERNAME} --password-stdin
          docker build --push \
            -t ${REGISTRY}/${GH_REGISTRY_USERNAME}/${IMAGE_NAME}:latest .
